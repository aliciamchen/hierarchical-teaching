---
title: "experiment 1"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(here)
library(ggthemes)
library(tidyboot)
library(optimx)
library(dfoptim)
library(afex)
library(brms)

options(contrasts = c(unordered = "contr.sum", ordered = "contr.poly"))

theme_set(theme_few(base_size = 20))
```

```{r include=FALSE}
d <- read_csv(here('../../data/teacher_1d/data_expt1.csv')) %>% 
  filter(understood == "yes", n_attention_passed >= 2) %>% 
  rename(n_turtles = total_ex) %>% 
  mutate(sequential = ifelse(block_type == "nonSeqFull" | block_type == "nonSeqPartial", "non_sequential", "sequential"),
        feedback = ifelse(block_type == "seqFeedback", "feedback", "no_feedback"),
        teacher_knowledge = ifelse(block_type == "nonSeqFull", "full", "partial"),
        student_prior = ifelse((theta == 0.3 & student_a == 1) | (theta == 0.7 & student_a == 9), "too_high", "too_low"),
        n_majority = ifelse(theta == 0.7, heads, tails),
        n_minority = n_turtles - n_majority,
        proportion_majority = n_majority / n_turtles,
        trial_num = ifelse(trial_num == 0, 'lesson1', 'lesson2'), 
        student_idx = factor(student_idx)) 
  

d.seq <- d %>%
  filter(sequential == 'sequential', total_bonus > 0, understood == "yes") %>% 
  pivot_wider(names_from = trial_num,
              values_from = proportion_majority,
              id_cols = c("subject_id", 
                          "student_idx",
                          "student_prior", 
                          "feedback")) %>%
  mutate(mean_diff = lesson2 - lesson1) 
```

How many participants? 
TODO: looka t percentage passed certain number of attention checks 

```{r}
length(unique(d$subject_id))
```

```{r include=FALSE}
d.model <- read.csv(here('../../model/teacher/experiment/output/v6_point_alpha1_cost0.01_120.csv')) %>% 
  mutate(
    n_turtles = heads + tails,
    sequential = ifelse(block_type == "nonSeqFull" | block_type == "nonSeqPartial", "non_sequential", "sequential"),
    feedback = ifelse(block_type == "seqFeedback", "feedback", "no_feedback"),
    student_a = ifelse(student_class == "A", 1, 9), 
    student_b = ifelse(student_class == "A", 9, 1), 
    teacher_knowledge = ifelse(block_type == "nonSeqFull", "full", "partial"),
    student_prior = ifelse((theta == 0.3 & student_a == 1) | (theta == 0.7 & student_a == 9), "too_high", "too_low"),
    n_majority = ifelse(theta == 0.7, heads, tails),
    n_minority = n_turtles - n_majority,
    proportion_majority = n_majority / n_turtles,
    trial_num = ifelse(trial_num == 0, 'lesson1', 'lesson2')
  )

## TODO: filter out how to filter by `subject_id` (filter by indices?)
## to make d.model.seq

d.model.seq <- d.model %>%
  filter(sequential == 'sequential') %>% 
  pivot_wider(names_from = trial_num,
              values_from = proportion_majority,
              id_cols = c( "subject_id", 
                           "theta",
                          "student_prior", 
                          "feedback")) %>%
  mutate(mean_diff = lesson2 - lesson1)
```

# Non-sequential conditions

Are participants sensitive to the student's prior? 

```{r}
d.nonseq <- d %>% filter(sequential == "non_sequential")

d.nonseq.means <- d.nonseq %>% 
  group_by(student_prior, teacher_knowledge) %>% 
  tidyboot_mean(
    n_majority / n_turtles, na.rm = T
  )

d.nonseq.means
```

```{r}
ggplot(d.nonseq.means, aes(x = teacher_knowledge, y = empirical_stat, color = student_prior)) + 
    geom_point(size = 3, position = position_dodge(width = 0.1)) + 
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1, width = 0, position = position_dodge(width = 0.1)) + 
    geom_hline(yintercept = 0.7, linetype = "dashed") +
    theme(aspect.ratio = 1) + 
    labs(x = "teacher knowledge", y = "proportion majority color", col = "student prior", title = "one-shot teaching (data)")
```



```{r}
nonseq.mod <- lmer_alt(
       n_majority / n_turtles ~ 1 
                              + student_prior * teacher_knowledge 
                              + (1 + student_prior * teacher_knowledge | subject_id),
       data = d.nonseq,
       control = glmerControl(optimizer = "bobyqa"),
       family = binomial,
       weights = d.nonseq$n_turtles
      )

summary(nonseq.mod)
```

Check modeling assumptions

```{r}
plot(nonseq.mod)
qqnorm(residuals(nonseq.mod))
```


# Sequential conditions

Are participants sensitive to student feedback? 

Start by looking at distribution of `mean_diff`

```{r}
d.seq.means <- d.seq %>% 
  group_by(student_prior, feedback) %>% 
  tidyboot_mean(
    mean_diff, na.rm = T
  )

d.seq.means
```

```{r}
ggplot(d.seq.means, aes(x = feedback, y = empirical_stat, color = student_prior)) + 
    geom_point(size = 3, position = position_dodge(width = 0.1)) + 
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1, width = 0, position = position_dodge(width = 0.1)) + 
    geom_hline(yintercept = 0, linetype = "dashed") +
    theme(aspect.ratio = 1) + 
    labs(x = "feedback", y = "change from lesson 1", col = "student prior", title = "sequential conditions (data)")
```


Linear model with `mean_diff`
```{r}
seq.mod <- lmer_alt(
    mean_diff ~ 1 + feedback * student_prior + (1 +  feedback * student_prior | subject_id), 
    data = d.seq, 
   control = lmerControl(optimizer = "bobyqa")
)

summary(seq.mod)
```

Check modeling assumptions
```{r}
plot(seq.mod)
qqnorm(residuals(seq.mod))
ggplot(d.seq, aes(x = mean_diff)) + 
  geom_histogram(bins = 50)
```

## Two separate logistic regressions


```{r}
ggplot(d %>% filter(sequential == "sequential", feedback == "feedback", student_prior == "too_high", trial_num == "lesson2"), aes(x = n_majority / n_turtles)) + 
  geom_histogram(bins = 30) + 
    geom_vline(xintercept = 0.7, linetype = "dashed", color = "red") +
  labs(title = "too high (only lesson 2, feedback)") 

ggplot(d %>% filter(sequential == "sequential", feedback == "feedback", student_prior == "too_low", total_bonus > 0, trial_num == "lesson2"), aes(x = n_majority / n_turtles)) + 
  geom_histogram(bins = 30) + 
    geom_vline(xintercept = 0.7, linetype = "dashed", color = "red") +
  labs(title = "too low (only lesson 2, feedback)")

```

Plot `too_high` and `too_low` conditions

```{r}
# plots for too high

d.seq.toohigh.means <- d %>% 
  filter(sequential == "sequential", student_prior == "too_high") %>% 
  group_by(feedback, trial_num) %>% 
  tidyboot_mean(
    n_majority / n_turtles, na.rm = T
  )

ggplot(d.seq.toohigh.means, aes(x = trial_num, y = empirical_stat, color = feedback)) + 
    geom_point(size = 3, position = position_dodge(width = 0.1)) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1, width = 0, position = position_dodge(width = 0.1)) + 
    theme(aspect.ratio = 1) + 
    geom_hline(yintercept = 0.7, linetype = "dashed") +
  labs(x = "lesson num", y = "proportion majority color", title = "too high (data)")

# plots for too low

d.seq.toolow.means <- d %>% 
  filter(sequential == "sequential", student_prior == "too_low") %>% 
  group_by(feedback, trial_num) %>% 
  tidyboot_mean(
    n_majority / n_turtles, na.rm = T
  )

ggplot(d.seq.toolow.means, aes(x = trial_num, y = empirical_stat, color = feedback)) + 
    geom_point(size = 3, position = position_dodge(width = 0.1)) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1, width = 0, position = position_dodge(width = 0.1)) + 
    theme(aspect.ratio = 1) + 
    geom_hline(yintercept = 0.7, linetype = "dashed") +
  labs(x = "lesson num", y = "proportion majority color", title = "too low (data)")
```

```{r}

d.toohigh <- d %>% filter(sequential == "sequential", student_prior == "too_high")
  
seq.mod.toohigh <- lmer_alt(
       n_majority / n_turtles ~ 1 + trial_num * feedback + (1 + trial_num + feedback | subject_id), 
        data = d.toohigh, 
        weights = d.toohigh$n_turtles,
        family = "binomial",
        control = glmerControl(optimizer = "bobyqa")
      )

summary(seq.mod.toohigh)
```      


```{r}      

d.toolow <- d %>% filter(sequential == "sequential", student_prior == "too_low")

seq.mod.toolow <- brm(
       n_majority | trials(n_turtles) ~ 1 + trial_num * feedback + (1 + trial_num * feedback | subject_id),
        data = d.toolow,
        family = "binomial"
      )

summary(seq.mod.toolow)
```

# For power analysis: View means and SD for feedback case

```{r}
d %>%
  filter(block_type == "seqFeedback") %>%
  group_by(trial_num) %>%
  summarize(
    mean = mean(normalized_mean, na.rm = T),
    sd = sd(normalized_mean, na.rm = T)
  )
```

# Model

## Nonsequential

```{r}
d.nonseq <- d.model %>% filter(sequential == "non_sequential")

d.nonseq.means <- d.nonseq %>% 
  group_by(student_prior, teacher_knowledge) %>% 
  tidyboot_mean(
    n_majority / n_turtles, na.rm = T
  )

d.nonseq.means
```

```{r}
ggplot(d.nonseq.means, aes(x = teacher_knowledge, y = empirical_stat, color = student_prior)) + 
    geom_point(size = 3, position = position_dodge(width = 0.1)) + 
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1, width = 0, position = position_dodge(width = 0.1)) + 
    geom_hline(yintercept = 0.7, linetype = "dashed") +
    theme(aspect.ratio = 1) + 
    labs(x = "teacher knowledge", y = "proportion majority color", col = "student prior", title = "one-shot teaching (model)")
```



```{r}
nonseq.mod <- lmer_alt(
       n_majority / n_turtles ~ 1 
                              + student_prior * teacher_knowledge 
                              + (1 + student_prior * teacher_knowledge | subject_id),
       data = d.nonseq,
       control = glmerControl(optimizer = "bobyqa"),
       family = binomial,
       weights = d.nonseq$n_turtles
      )

summary(nonseq.mod)
```

## Sequential 

```{r}
# plots for too high

d.seq.toohigh.means <- d.model %>% 
  filter(sequential == "sequential", student_prior == "too_high") %>% 
  group_by(feedback, trial_num) %>% 
  tidyboot_mean(
    n_majority / n_turtles, na.rm = T
  )

ggplot(d.seq.toohigh.means, aes(x = trial_num, y = empirical_stat, color = feedback)) + 
    geom_point(size = 3, position = position_dodge(width = 0.1)) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1, width = 0, position = position_dodge(width = 0.1)) + 
    theme(aspect.ratio = 1) + 
    geom_hline(yintercept = 0.7, linetype = "dashed") +
  labs(x = "lesson num", y = "proportion majority color", title = "too high (model)")

# plots for too low

d.seq.toolow.means <- d.model %>% 
  filter(sequential == "sequential", student_prior == "too_low") %>% 
  group_by(feedback, trial_num) %>% 
  tidyboot_mean(
    n_majority / n_turtles, na.rm = T
  )

ggplot(d.seq.toolow.means, aes(x = trial_num, y = empirical_stat, color = feedback)) + 
    geom_point(size = 3, position = position_dodge(width = 0.1)) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1, width = 0, position = position_dodge(width = 0.1)) + 
    theme(aspect.ratio = 1) + 
    geom_hline(yintercept = 0.7, linetype = "dashed") +
  labs(x = "lesson num", y = "proportion majority color", title = "too low (model)")
```

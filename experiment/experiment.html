<!DOCTYPE html>
<html>

<head>
    <title>Teaching game</title>

    <script src="https://unpkg.com/jspsych@7.2.1"></script>

    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.0"></script>

    <link href="https://unpkg.com/jspsych@7.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        p {
            width: 70%;
            margin: auto;
            margin-bottom: 15px;
            text-align: left
        }
    </style>
</head>

<body></body>

<script>

    /* Experiment parameters */

    const params = {
        nStudents: 24,
        maxFlips: 20,
        completionMinutes: 15,
        basePay: 10,
        maxBonus: 12,
        perTrialBonus: 0.5,
        perTrialBonusThreshold: 0.1,
        exampleCost: 0.02
    };

    const classroomParams = {
        A: { a: 1, b: 4 },
        B: { a: 4, b: 1 },
        C: { a: 2, b: 8 },
        D: { a: 8, b: 2 }
    };

    const conditions = ['nonSeqFull', 'nonSeqPartial', 'seqNoFeedback', 'seqFeedback'];
    const classroomPairings = [['A', 'B'], ['C', 'D']];
    const coinWeights = [0.2, 0.5, 0.8];

    const factors = {
        condition: conditions,
        classroomPairing: classroomPairings,
        coinWeight: coinWeights
    }


    /* Experiment */

    var jsPsych = initJsPsych({
        on_finish: function () {
            jsPsych.data.displayData();
        },
        show_progress_bar: true
    });

    var timeline = [];


    var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: 'Welcome to the experiment. Press any key to begin.',
        trial_duration: 20000
    }

    timeline.push(welcome);


    var consent = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
        <h3>Please read this consent agreement carefully before deciding whether to participate in this experiment.</h3>
        <p>Purpose of the research: To examine how people teach effectively.</p>
        <p>What you will do in this research: You will teach students the weights of different coins.</p>
        <p>Time required: This experiment will take ${params.completionMinutes} minutes to complete.</p>
        <p>Risks: There are no anticipated risks associated with participating in this study. \
            The effects of participating should be comparable to those you would experience from viewing a computer monitor \
            and using a mouse and keyboard for the duration of the experiment.</p>
        <p>Benefits: The study provides important information about the nature of teaching.</p>
        <p>Compensation: You will receive $${params.basePay} for completing the experiment and a performance bonus of up to $${params.maxBonus}.</p>
        <p>Confidentiality: Your participation in this study will remain confidential. \
            No personally identifiable information will be associated with your data. \
            Your de-identified data may be shared with other researchers and used in future projects.</p>
        <p>Participation and withdrawal: Your participation in this study is completely voluntary and \
            you may refuse to participate or you may choose to withdraw at any time without penalty or loss of
            benefits to which you are otherwise entitled.</p>
        <p>How to contact the researcher: If you have questions or concerns about your participation\
            or payment, or want to request a summary of research findings, please contact
            Alicia Chen, aliciachen@college.harvard.edu.</p>
        <p>Whom to contact about your rights in this research: For questions, concerns, suggestions, \
            or complaints that have not been or cannot be addressed by the researcher, or to report \
            research-related harm, please contact the Committee on the Use of Human Subjects in Research at Harvard University, \
            1414 Massachusetts Avenue, Second Floor, Cambridge, MA 02138. Phone: 617-496-2847. Email: cuhs@fas.harvard.edu.</p>
        `,
        choices: ['I consent']
    };

    timeline.push(consent);

    var instructions = {
        type: jsPsychInstructions,
        pages: [
            // Page 1
            `<p>Please read the following instructions carefully as there will be a comprehension quiz. \
            If your answers on the comprehension quiz indicate that you have not read the instructions, \
            we will repeat them.</p>`,

            // Page 2
            `<p>You are a teacher. You will be paired with students and your goal is to teach effectively.</p>`,

            // Page 3
            `<p>You will be teaching students the weight of coins.</p>
            <p>But aren't all coins equally likely to land heads or tails? This is not the case here!\
                You (and your students) have landed on an alien planet where you have all been told that coins can be any weight.</p>
            <p>We will represent coin weights with a <b>number between 0 and 1</b>. \
                The higher the weight, the more likely the coin is to land heads.</p>
            <p>A weight of 0.5 means that the coin is fair, like the coins you are used to on planet Earth. \
                A weight of 0.8 means that the coin is engineered so that it lands heads 80% of the time.</p>
            <p>You will be teaching a total of ${params.nStudents} students, for a total of ${params.nStudents} blocks. In each block, you will encounter a new student. \
                You will receive a coin and we will tell you its weight. The student won't know its weight.</p>`,

            // Page 4
            `<h3>What kind of information can I give to my students to lead them to the correct coin weights?</h3>
            <p>You can only give information to students in the form of example outcomes of coin flips. \
                You can choose the number of heads and the number of tails to send to your student.</p>
            <p>Your goal is to provide examples to the student to lead them to the correct weight of the coin. \
                The student will see your examples and will use this information to guess the weight of the coin.</p>
            <p>Blocks consist of either one or two trials (we will tell you how many trials to expect at the beginning of each block). On each trial, you can send up to <b>${params.maxFlips}</b> examples to the student.</p>`,

            // Page 5
            `<p>However, you are not the first teacher your students have encountered, \
                nor are the coin flips you show your students the first coin flips they have seen on this alien planet! \
                Each student you see will come from one of four classrooms, where they have seen a bunch of flips before.</p>
            <p>Every time you encounter a new student, you will be given information about their classroom. We will display this information in <b style="color:DodgerBlue;">blue</b>.</p>
            <p>To teach effectively, you will want to consider how a learner's classroom affects \
                how they interpret the examples you give them.</p>`,

            // Page 6
            `<h3>How can I earn as much money as possible from this experiment?</h3>
            <p>You will want to teach <b>accurately</b> and <b>efficiently</b>.</p>
            <p>As the experiment is going on, your students will guess the coin weights. \
                On each trial, you will receive <b>$${params.perTrialBonus}</b> if the student's guess is within <b>${params.perTrialBonusThreshold}</b> of the actual coin weight.</p>
            <p>However, each flip that you give <em>costs</em> <b>$${params.exampleCost}</b>.</p>
            <p>This is similar to teaching in the real world: You want to lead the student to the right answer, but it's costly to give too much information!</p>
            <p>We will tell you how much you have earned at the end of each block.</p>
            <p style="color:Tomato;">On to the comprehension quiz! Feel free to flip back and forth in the instructions before pressing "Next" to proceed to the quiz.</p>
            `
        ],
        show_clickable_nav: true,
        show_page_number: true
    }


    /* Comprehension check */

    var comprehensionCheck = {
        type: jsPsychSurveyMultiChoice,
        questions: [
            {
                prompt: 'What are the differences between different classrooms?',
                options: [
                    'Students in different classrooms will have seen a different number of heads and tails before seeing the examples you select for them.',
                    'Students in different classrooms have seen a different proportion of fair and unfair coins before seeing the examples you select for them.',
                    `The classrooms are all the same and aren't helpful for deciding how to teach.`
                ],
                required: true
            },
            {
                prompt: 'How can you earn a high performance bonus?',
                options: [
                    'By giving as few examples as possible.',
                    `By giving ${params.maxFlips} examples (the maximum) on each trial and making sure that the students' guesses are as accurate as possible.`,
                    'By teaching efficiently and accurately at the same time.'
                ],
                required: true
            },
            {
                prompt: 'What does a coin weight of 0.9 mean?',
                options: [
                    'The coin lands heads 90% of the time.',
                    'The coin lands tails 90% of the time.'
                ],
                required: true
            },
            {
                prompt: `Is there a chance you'll encounter the same student in two different blocks?`,
                options: [
                    'Yes, I might encounter the same student twice.',
                    'No, I will teach a <b>new</b> student on each block.'
                ],
                required: true
            },
            {
                prompt: 'What planets are the students on?',
                options: [
                    'The students are all on planet Earth, where they tend to believe the vast majority of coins will be fair.',
                    'The students are also on the same alien planet as you, where coins can be unfair.'
                ],
                required: true
            }
        ],
        randomize_question_order: true,

        on_finish: function (data) {
            data.pass = [data.response.Q0.includes('heads'), data.response.Q1.includes('time'), data.response.Q2.includes('heads'), data.response.Q3.includes('new'), data.response.Q4.includes('unfair')].every(Boolean)
        }
    }

    var fail = {
        timeline: [{
            type: jsPsychHtmlButtonResponse,
            stimulus: `Oops, you have missed question(s) on the comprehension check! We'll show you the instructions again.`,
            choices: ["Got it!"]
        }],
        conditional_function: function() {
            const responses = jsPsych.data.getLastTrialData();
            return !responses.select("pass").values[0];
        }
    }

    var comprehensionLoop = {
        timeline: [instructions, comprehensionCheck, fail],
        loop_function: function (data) {
            return !data.select("pass").values[0];
        }

    }

    timeline.push(comprehensionLoop);

    /* Main logic of trials */

    var design = jsPsych.randomization.factorial(factors, 1)

    var beginning = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:30px;">Congrats on passing the comprehension quiz! The experiment will begin in a few seconds.</div>',
        choices: "NO_KEYS",
        trial_duration: 3000,
    }

    var firstStudentWarming = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:30px;">First student</div>',
        choices: "NO_KEYS",
        trial_duration: 3000,
    }

    timeline.push(beginning, firstStudentWarming);

    // Loop through individual trials in design to create timeline
    for (let i = 0; i < design.length; i++) {

        var currTrial = design[i];
        console.log(currTrial);
        var studentTrueClassroom = jsPsych.randomization.sampleWithoutReplacement(currTrial.classroomPairing, 1)[0];

        var classroomInfo = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <h4 style="color:Orange;">Student ${i+1}</h4>
            <h2>The weight of your coin is <b style="color:Tomato;">${currTrial.coinWeight}</b>.</h2>
            <p>In this block, you will be giving ${currTrial.condition === 'nonSeqPartial' || currTrial.condition === 'nonSeqFull' ? '<b>one</b> set of examples' : '<b>two</b> sets of examples'} to Student ${i+1}.</p>
                <p>${currTrial.condition === 'seqFeedback' ? `You will see the student's guess after the first set of examples. You will also receive feedback at the end of the block.` : 'You will receive feedback at the end of the block.'}</p>
            `,
            choices: ['Continue']
        }

        var firstExample = {
            type: jsPsychSurveyHtmlForm,
            preamble: `
                ${currTrial.condition === 'nonSeqFull' ? `
                        <h2>The weight of your coin is <b style="color:Tomato;">${currTrial.coinWeight}</b>.</h2>
                        <p style="color:DodgerBlue;"><b>Student info: </b> Student ${i+1} is from Classroom ${studentTrueClassroom}, where they have seen ${classroomParams[studentTrueClassroom].a} \
                            ${classroomParams[studentTrueClassroom].a === 1 ? 'head' : 'heads'} and ${classroomParams[studentTrueClassroom].b} ${classroomParams[studentTrueClassroom].b === 1 ? 'tail' : 'tails'}.</p>
                        <h3>Select a set of examples to send to your student.</h3>
                        <p>Remember you can only select a max of ${params.maxFlips} examples.</p>
                        ` : `
                        <h2>The weight of your coin is <b style="color:Tomato;">${currTrial.coinWeight}</b>.</h2>
                        <p style="color:DodgerBlue;"><b>Student info: </b> Student ${i+1} is from <b>either</b> classroom ${currTrial.classroomPairing[0]} or classroom ${currTrial.classroomPairing[1]}.</p>
                        <ul style="color:DodgerBlue;">
                            <li>The students in Classroom ${currTrial.classroomPairing[0]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[0]].a} \
                            ${classroomParams[currTrial.classroomPairing[0]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[0]].b} ${classroomParams[currTrial.classroomPairing[0]].b === 1 ? 'tail' : 'tails'}.</b></li>
                            <li>The students in Classroom ${currTrial.classroomPairing[1]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[1]].a} \
                            ${classroomParams[currTrial.classroomPairing[1]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[1]].b} ${classroomParams[currTrial.classroomPairing[1]].b === 1 ? 'tail' : 'tails'}.</b></li>
                        </ul>
                        <h3>Select a set of examples to send to your student.</h3>
                        <p>Remember you can only select a max of ${params.maxFlips} examples.</p>
                        `
                }`
            ,
            html: `
                <p> <input name="heads" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> heads </p>
                <p> <input name="tails" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> tails </p>`,
            trial_duration: 20000,
            data: {
                condition: currTrial.condition,
                trueTheta: currTrial.coinWeight,
                classrooms: currTrial.classroomPairing,
                studentTrueClassroom: studentTrueClassroom,
                exampleSet: 'first'
            },
            on_finish: function(data) {
                var nHeads = parseInt(data.response.heads);
                var nTails = parseInt(data.response.tails);
                var studentTrueHypers = classroomParams[data.studentTrueClassroom];
                var studentGuess = (parseInt(studentTrueHypers.a) + nHeads) / (parseInt(studentTrueHypers.a) + parseInt(studentTrueHypers.b) + nHeads + nTails);
                var delta = Math.abs(data.trueTheta - studentGuess);
                var reward = delta <= params.perTrialBonusThreshold ? params.perTrialBonus : 0
                var cost = params.exampleCost * (nHeads + nTails)

                data.studentIndex = i;
                data.studentTrueHypers = studentTrueHypers;
                data.studentGuess = studentGuess;
                data.delta = delta;
                data.bonus = Number((reward - cost) > 0 ? (reward - cost).toFixed(2) : 0)
                data.totalExamples = nHeads + nTails;
            }
        };

        var firstExampleLoop = {
            timeline: [firstExample],
            loop_function: function (data) {

                var totalFlips = parseInt(data.values()[0].response.heads) + parseInt(data.values()[0].response.tails)
                if ((totalFlips <= params.maxFlips) && (totalFlips > 0)) {
                    return false;
                } else {
                    return true;
                }
            }
        }

        var sending = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: 'Sending examples to student... ',
            choices: "NO_KEYS",
            trial_duration: function () {
                return jsPsych.randomization.sampleWithoutReplacement([1250, 1500, 1750, 2000], 1)[0];
            }
        }

        var feedback = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                // var rawResponses = jsPsych.data.get().values();
                // var twoTrialsAgo = rawResponses[rawResponses.length - 3];
                // console.log(twoTrialsAgo)

                var blockData = jsPsych.data.get()
                var firstResponse = blockData.filter({studentIndex: i, exampleSet: 'first'}).values()[0]
                // var nHeads = parseInt(twoTrialsAgo.response.heads);
                // var nTails = parseInt(twoTrialsAgo.response.tails);
                // var studentTrueHypers = classroomParams[twoTrialsAgo.studentTrueClassroom];

                // console.log(studentTrueHypers)
                // console.log(nHeads)
                // console.log(nTails)
                // var hatTheta =

                console.log(firstResponse);

                return `
                <p>Student's guess for coin weight: <b>${firstResponse.studentGuess.toFixed(2)}</b></p>
                <p>You received a bonus of <b>$${firstResponse.bonus}</b></p>
                <p>Total bonus so far: <b>$${Number(jsPsych.data.get().select('bonus').sum()).toFixed(2)}</b></p>
                <p>${firstResponse.condition === 'seqFeedback' ? 'You will now send another set of examples to your student.' : ''} Press any key to continue.</p>
                `
            },
            trial_duration: 20000
        }
        // add function that samples from student class, saves info, and calculates hypers based on teacher's data

        var secondExample = {
            type: jsPsychSurveyHtmlForm,
            preamble: `<h2>Select another set of examples to send to the same student.</h2>
                        <p style="color:DodgerBlue; text-align: center;">Reminders:</p>
                        <ul style="color:DodgerBlue;">
                            <li>The weight of your coin is ${currTrial.coinWeight}.</li>
                            <li>Student ${i+1} is from <b>either</b> Classroom ${currTrial.classroomPairing[0]} or Classroom ${currTrial.classroomPairing[1]}.</li>
                            <li>The students in Classroom ${currTrial.classroomPairing[0]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[0]].a} \
                            ${classroomParams[currTrial.classroomPairing[0]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[0]].b} ${classroomParams[currTrial.classroomPairing[0]].b === 1 ? 'tail' : 'tails'}.</b></li>
                            <li>The students in Classroom ${currTrial.classroomPairing[1]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[1]].a} \
                            ${classroomParams[currTrial.classroomPairing[1]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[1]].b} ${classroomParams[currTrial.classroomPairing[1]].b === 1 ? 'tail' : 'tails'}.</b></li>
                        </ul>
            <p>Remember you can only select a max of ${params.maxFlips} examples.</p>
            `,
            html: `
                <p> <input name="heads" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> heads </p>
                <p> <input name="tails" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> tails </p>`,
            trial_duration: 20000,
            data: {
                condition: currTrial.condition,
                trueTheta: currTrial.coinWeight,
                classrooms: currTrial.classroomPairing,
                studentTrueClassroom: studentTrueClassroom,
                exampleSet: 'second'
            },
            on_finish: function(data) {
                var nHeads = parseInt(data.response.heads);
                var nTails = parseInt(data.response.tails);
                var studentTrueHypers = classroomParams[data.studentTrueClassroom];
                var studentGuess = (parseInt(studentTrueHypers.a) + nHeads) / (parseInt(studentTrueHypers.a) + parseInt(studentTrueHypers.b) + nHeads + nTails);
                var delta = Math.abs(data.trueTheta - studentGuess);
                var reward = delta <= params.perTrialBonusThreshold ? params.perTrialBonus : 0
                var cost = params.exampleCost * (nHeads + nTails)

                data.studentIndex = i;
                data.studentTrueHypers = studentTrueHypers;
                data.studentGuess = studentGuess;
                data.delta = delta;
                data.bonus = Number((reward - cost) > 0 ? (reward - cost).toFixed(2) : 0);
                data.totalExamples = nHeads + nTails;
            }
        };

        var secondExampleLoop = {
            timeline: [secondExample],
            loop_function: function (data) {

                var totalFlips = parseInt(data.values()[0].response.heads) + parseInt(data.values()[0].response.tails)
                if ((totalFlips <= params.maxFlips) && (totalFlips > 0)) {
                    return false;
                } else {
                    return true;
                }
            }
        }

        var sent = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: 'Examples sent to student!',
            choices: "NO_KEYS",
            trial_duration: function () {
                return jsPsych.randomization.sampleWithoutReplacement([3000, 3500, 4000, 4500, 5000], 1)[0];
            }
        }

        var finalSequentialFeedback = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                // var rawResponses = jsPsych.data.get().values();
                // var twoTrialsAgo = rawResponses[rawResponses.length - 3];
                // console.log(twoTrialsAgo)
                // var nHeads = parseInt(twoTrialsAgo.response.heads);
                // var nTails = parseInt(twoTrialsAgo.response.tails);
                // var studentTrueHypers = classroomParams[twoTrialsAgo.studentTrueClassroom];

                // console.log(studentTrueHypers)
                // console.log(nHeads)
                // console.log(nTails)
                // var hatTheta =

                var blockData = jsPsych.data.get()

                // TODO: filter student id
                var firstResponse = blockData.filter({studentIndex: i, exampleSet: 'first'}).values()[0]
                var secondResponse = blockData.filter({studentIndex: i, exampleSet: 'second'}).values()[0]

                console.log(firstResponse)
                console.log(secondResponse)

                return `
                <p>Student ${i+1}'s first guess for coin weight: <b>${firstResponse.studentGuess.toFixed(2)}</b></p>
                <p>Student ${i+1}'s second guess for coin weight: <b>${secondResponse.studentGuess.toFixed(2)}</b></p>
                <p>You received a bonus of ${secondResponse.condition === 'seqNoFeedback' ? `<b>$${firstResponse.bonus.toFixed(2)}</b> for the first guess and` : ''} $<b>${secondResponse.bonus.toFixed(2)}</b> for the second guess.</p>
                <p>Your total bonus for student ${i+1} is <b>$${(Number(firstResponse.bonus) + Number(secondResponse.bonus)).toFixed(2)}</b>.</p>
                <p>Total bonus so far: <b>$${Number(jsPsych.data.get().select('bonus').sum()).toFixed(2)}</b></p>
                <p>Press any key to continue.</p>
                `
            },
            trial_duration: 20000
        }

        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px;">Next student</div>',
            choices: "NO_KEYS",
            trial_duration: function () {
                return jsPsych.randomization.sampleWithoutReplacement([2000, 2250, 2500, 3000], 1)[0];
            },
            data: {
                task: 'fixation'
            }
        }


        const trialsInCondition = {
            'nonSeqFull': [classroomInfo, firstExampleLoop, sending, sent, feedback, fixation],
            'nonSeqPartial': [classroomInfo, firstExampleLoop, sending, sent, feedback, fixation],
            'seqNoFeedback': [classroomInfo, firstExampleLoop, sending, sent, secondExampleLoop, sending, sent, finalSequentialFeedback, fixation],
            'seqFeedback': [classroomInfo, firstExampleLoop, sending, sent, feedback, secondExampleLoop, sending, sent, finalSequentialFeedback, fixation],
        }

        timeline.push(trialsInCondition[currTrial.condition])
    }


    var test = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: ['f', 'j'],
        data: {
            task: 'response',
            correct_response: jsPsych.timelineVariable('correct_response')
        },
        on_finish: function (data) {
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
        }
    }

    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {

            var totalBonus = jsPsych.data.get().select('bonus').sum().toFixed(2);

            return `
                <p>Thanks for participating in the experiment!</p>
                <p>Your total bonus is <b>$${totalBonus}</b>.</p>
                <p>Your total pay is <b>$${totalBonus + params.basePay}</b></p>
                <p>If you were curious, you weren't interacting with a real learner.</p>
                <p>Press any key to exit.</p>
                `;

        }
    };

    timeline.push(debrief_block);

    jsPsych.run(timeline.flat());

</script>

</html>
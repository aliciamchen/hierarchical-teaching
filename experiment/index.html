<!DOCTYPE html>
<html>

<head>
    <title>Teaching game</title>

    <script src="https://unpkg.com/jspsych@7.2.1"></script>

    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.0"></script>

    <link href="https://unpkg.com/jspsych@7.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        p {
            width: 70%;
            margin: auto;
            margin-bottom: 15px;
            text-align: left
        }
    </style>
</head>

<body></body>

<script>


    /* Experiment parameters */

    const params = {
        nStudents: 24,
        maxFlips: 25,
        completionMinutes: 45,
        basePay: 8,
        maxBonus: 9,
        perTrialBonus: 0.5,
        perTrialBonusThreshold: 0.05,
        exampleCost: 0.02
    };

    const classroomParams = {
        A: { a: 1, b: 4 },
        B: { a: 4, b: 1 },
        C: { a: 2, b: 8 },
        D: { a: 8, b: 2 }
    };

    const conditions = ['nonSeqFull', 'nonSeqPartial', 'seqNoFeedback', 'seqFeedback'];
    const classroomPairings = [['A', 'B'], ['C', 'D']];
    const coinWeights = [0.2, 0.5, 0.8];

    const factors = {
        condition: conditions,
        classroomPairing: classroomPairings,
        coinWeight: coinWeights
    }



    /* Start experiment */

    const local_testing = false;

    var jsPsych = initJsPsych({
        on_finish: function () {
            if (local_testing) {
                jsPsych.data.get().localSave("json", "testdata.json"); // add datetime later
            }
        },
        show_progress_bar: true
    });

    jsPsych.data.addProperties({
        params: params,
        classroomParams: classroomParams,
        conditions: conditions,
        classroomPairings: classroomPairings,
        coinWeights: coinWeights
    })


    /* Save stuff */

    function save_data_json(name, data) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "./save_data.php");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify({ filename: name, filedata: data }));
    }

    const turkInfo = jsPsych.turk.turkInfo();

    const subjectId =
        local_testing || turkInfo.workerId == ""
            ? jsPsych.randomization.randomID(12)
            : turkInfo.workerId;

    jsPsych.data.addProperties({
        subjectId: subjectId,
        assignmentId: turkInfo.assignmentId,
        hitId: turkInfo.hitId,
        url: window.location.href
    });

    const save_data = {
        type: jsPsychCallFunction,
        func: function () {
            save_data_json(subjectId + "_output_all", jsPsych.data.get().json());
            save_data_json(subjectId + "_output_responsesOnly", jsPsych.data.get().filter({type: 'response'}).json())
        },
        timing_post_trial: 0
    };



    /* Experiment */


    var timeline = [];


    // Welcome and introduction

    var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: 'Welcome to the experiment. Press any key to begin.',
        trial_duration: 30000
    }

    timeline.push(welcome);


    var consent = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
        <h3>Please read this consent agreement carefully before deciding whether to participate in this experiment.</h3>
        <p><b>Purpose of the research:</b> To examine how people teach effectively.</p>
        <p><b>What you will do in this research:</b> You will teach students the weights of different coins.</p>
        <p><b>Time required:</b> This experiment will take ${params.completionMinutes} minutes to complete.</p>
        <p><b>Risks:</b> There are no anticipated risks associated with participating in this study. \
            The effects of participating should be comparable to those you would experience from viewing a computer monitor \
            and using a mouse and keyboard for the duration of the experiment.</p>
        <p><b>Benefits:</b> The study provides important information about the nature of teaching.</p>
        <p><b>Compensation:</b> You will receive <b>$${params.basePay}</b> for completing the experiment and a performance bonus of up to <b>$${params.maxBonus}</b>.</p>
        <p><b>Confidentiality:</b> Your participation in this study will remain confidential. \
            No personally identifiable information will be associated with your data. \
            Your de-identified data may be shared with other researchers and used in future projects.</p>
        <p><b>Participation and withdrawal:</b> Your participation in this study is completely voluntary and \
            you may refuse to participate or you may choose to withdraw at any time without penalty or loss of
            benefits to which you are otherwise entitled.</p>
        <p><b>How to contact the researcher:</b> If you have questions or concerns about your participation\
            or payment, or want to request a summary of research findings, please contact
            Alicia Chen, aliciachen@college.harvard.edu.</p>
        <p><b>Whom to contact about your rights in this research:</b> For questions, concerns, suggestions, \
            or complaints that have not been or cannot be addressed by the researcher, or to report \
            research-related harm, please contact the Committee on the Use of Human Subjects in Research at Harvard University, \
            1414 Massachusetts Avenue, Second Floor, Cambridge, MA 02138. Phone: 617-496-2847. Email: cuhs@fas.harvard.edu.</p>
        `,
        choices: ['I consent']
    };

    timeline.push(consent);

    var instructions = {
        type: jsPsychInstructions,
        pages: [
            // Page 1
            `<p>Please read the following instructions carefully as there will be a comprehension quiz. \
            If your answers on the comprehension quiz indicate that you have not read the instructions, \
            we will repeat them.</p>`,

            // Page 2
            `<p>You are a teacher. You will be paired with students and your goal is to teach effectively.</p>`,

            // Page 3
            `<p>You will be teaching students the weight of coins.</p>
            <p>But aren't all coins equally likely to land heads or tails? This is not the case here!\
                You (and your students) have landed on an alien planet where you have all been told that coins can be unfair.</p>
            <p>We will represent coin weights with a <b>number between 0 and 1</b>. \
                The higher the weight, the more likely the coin is to land heads.</p>
            <p>A weight of 0.5 means that the coin is fair, like the coins you are used to on planet Earth. \
                A weight of 0.8 means that the coin is engineered so that it lands heads 80% of the time.</p>
            <p>You will be teaching a total of ${params.nStudents} students. For each student, \
                you will receive a coin and we will tell you its weight. The student won't know its weight.</p>`,

            // Page 4
            `<h3>What kind of information can I give to my students to lead them to the correct coin weights?</h3>
            <p>You can only give information to students in the form of <b>example outcomes</b> ("examples") of coin flips. \
                You can choose the number of heads and the number of tails to send to your student.</p>
            <p>In other words, you can give information to your students by telling them how many tosses ended up in heads and how many ended up in tails.</>
            <p>Your goal is to provide examples for the student to lead them to the correct weight of the coin. \
                The student will see your examples and will use this information to guess the weight of the coin.</p>`,

            // Page 5
            `<p>Again, you will be teaching <b>${params.nStudents}</b> students. You will teach each student over either one or two trials (we will tell you how many trials to expect when you encounter a new student). \
                On each trial, you can send up to <b>${params.maxFlips}</b> examples to the student.</p>`,

            // Page 6
            `<h2 style="color:Tomato;">Important</h2>
            <p>You are not the first teacher your students have encountered, \
                nor are the coin flips you show your students the first coin flips they have seen on this alien planet! \
                Each student you see will come from one of four classrooms, from which they have already seen a certain number of <b>coin flip outcomes</b>.</p>
            <p>Every time you encounter a new student, you will be given information about their classroom. We will display this information in <b style="color:DodgerBlue;">blue</b>.</p>
            <p><b style="color:Tomato;">To teach effectively, you will want to consider how a student's classroom affects \
                how they interpret the examples you give them.</b></p>`,

            // Page 7
            `<h3>How can I earn as much money as possible from this experiment?</h3>
            <p>You will want to teach <b>helpfully</b> and <b>efficiently</b>.</p>
            <p>As the experiment is going on, your students will guess the coin weights. \
                In addition to the base pay of <b>$${params.basePay}</b>, for each student you will earn an extra <b>$${params.perTrialBonus}</b> if their guess is within <b>${params.perTrialBonusThreshold}</b> of the actual coin weight.</p>
            <p>(For the students that you'll teach over two trials, you will a receive a bonus based on the student's <b>final</b> guess, which takes into consideration the examples you have \
                given them on <em>both</em> trials.)</p>
            <p>However, each example that you give <em>costs</em> <b>$${params.exampleCost}</b>. (For example, all else being equal, sending 20 heads costs more than sending 10 heads.)</p>
            <p>After you finish teaching a student, we will tell you how much you have earned for that student.</p>
            <p style="color:Tomato;">On to the comprehension quiz! Feel free to flip back and forth in the instructions before pressing "Next" to proceed to the quiz.</p>
            `
        ],
        show_clickable_nav: true,
        show_page_number: true
    }


    var comprehensionCheck = {
        type: jsPsychSurveyMultiChoice,
        questions: [
            {
                prompt: 'What are the differences between different classrooms?',
                options: [
                    'Students in different classrooms will have seen a different number of heads and tails before seeing the examples you select for them.',
                    'Students in different classrooms have seen a different proportion of fair and unfair coins before seeing the examples you select for them.',
                    `The classrooms are all the same and aren't helpful for deciding how to teach.`
                ],
                required: true
            },
            {
                prompt: 'How can you earn a high performance bonus?',
                options: [
                    'By giving as few examples as possible.',
                    `By giving ${params.maxFlips} examples (the maximum) on each trial so I can make sure that the students' guesses are as accurate as possible.`,
                    `By <b>considering the student's classroom information</b> so that I can teach efficiently and accurately/helpfully at the same time (because each example I give to the student costs money!).`
                ],
                required: true
            },
            {
                prompt: 'What does a coin weight of 0.9 mean?',
                options: [
                    'The coin lands heads 90% of the time.',
                    'The coin lands tails 90% of the time.'
                ],
                required: true
            },
            {
                prompt: `Is there a chance you'll encounter the same student twice?`,
                options: [
                    'Yes, I might encounter the same student twice.',
                    'No, I will teach a <b>new</b> student each time.'
                ],
                required: true
            },
            {
                prompt: 'What planets are the students on?',
                options: [
                    'The students are all on planet Earth, where they tend to believe the vast majority of coins will be fair.',
                    'The students are also on the same alien planet as you, where coins can be unfair.'
                ],
                required: true
            },
            {
                prompt: `For the students to which I'll give two sets of examples, how will my bonus be calculated?`,
                options: [
                    `Based on the student's first guess.`,
                    `Based on the student's second (and final) guess.`,
                    'Based on both guesses.'
                ],
                required: true
            }
        ],
        randomize_question_order: true,

        on_finish: function (data) {
            data.pass = [data.response.Q0.includes('heads'), data.response.Q1.includes('time'), data.response.Q2.includes('heads'), data.response.Q3.includes('new'), data.response.Q4.includes('unfair'), data.response.Q5.includes('second')].every(Boolean)
        }
    }

    var fail = {
        timeline: [{
            type: jsPsychHtmlButtonResponse,
            stimulus: `Oops, you have missed question(s) on the comprehension check! We'll show you the instructions again.`,
            choices: ["Got it!"]
        }],
        conditional_function: function () {
            const responses = jsPsych.data.getLastTrialData();
            return !responses.select("pass").values[0];
        }
    }

    var comprehensionLoop = {
        timeline: [instructions, comprehensionCheck, fail],
        loop_function: function (data) {
            return !data.select("pass").values[0];
        }

    }

    timeline.push(comprehensionLoop);


    /* Main logic of trials */

    var design = jsPsych.randomization.factorial(factors, 1)

    var beginning = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:30px;">Congrats on passing the comprehension quiz! The experiment will begin in a few seconds.</div>',
        choices: "NO_KEYS",
        trial_duration: 3000,
    }

    var firstStudentWarning = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:50px;">First student</div>',
        choices: "NO_KEYS",
        trial_duration: 3000,
    }

    timeline.push(beginning, firstStudentWarning);

    // Loop through individual trials in design to create timeline
    // i < design.length
    for (let i = 0; i < design.length; i++) {

        var currTrial = design[i];
        // console.log(currTrial);
        var studentTrueClassroom = jsPsych.randomization.sampleWithoutReplacement(currTrial.classroomPairing, 1)[0];

        var classroomInfo = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <h4 style="color:Orange;">Student ${i + 1}</h4>
            <h2>The weight of your coin is <b style="color:Tomato;">${currTrial.coinWeight}</b>.</h2>
            <p>In this block, you will be giving ${currTrial.condition === 'nonSeqPartial' || currTrial.condition === 'nonSeqFull' ? '<b>one</b> set of examples' : '<b>two</b> sets of examples'} to Student ${i + 1}.</p>
                <p>${currTrial.condition === 'seqFeedback' ? `You will see the student's guess after the first set of examples. You will also receive feedback at the end of the block.` : 'You will receive feedback at the end of the block.'}</p>
            <p>${currTrial.condition == 'seqFeedback' ? `To earn the highest bonus, you will have to <b>take into consideration the student's guess</b> when you choose your second set of examples.`: ''}</p>`,
            choices: ['Continue']
        }

        var firstExample = {
            type: jsPsychSurveyHtmlForm,
            preamble: `
                ${currTrial.condition === 'nonSeqFull' ? `
                        <h2>The weight of your coin is <b style="color:Tomato;">${currTrial.coinWeight}</b>.</h2>
                        <p style="color:DodgerBlue;"><b>Student info: </b> Student ${i + 1} is from Classroom ${studentTrueClassroom}, where they have seen ${classroomParams[studentTrueClassroom].a} \
                            ${classroomParams[studentTrueClassroom].a === 1 ? 'head' : 'heads'} and ${classroomParams[studentTrueClassroom].b} ${classroomParams[studentTrueClassroom].b === 1 ? 'tail' : 'tails'}.</p>
                        <h3>Select a set of examples to send to your student.</h3>
                        <p>Remember you can only select a max of ${params.maxFlips} examples.</p>
                        ` : `
                        <h2>The weight of your coin is <b style="color:Tomato;">${currTrial.coinWeight}</b>.</h2>
                        <p style="color:DodgerBlue;"><b>Student info: </b> Student ${i + 1} is from <b>either</b> classroom ${currTrial.classroomPairing[0]} or classroom ${currTrial.classroomPairing[1]}.</p>
                        <ul style="color:DodgerBlue;">
                            <li>The students in Classroom ${currTrial.classroomPairing[0]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[0]].a} \
                            ${classroomParams[currTrial.classroomPairing[0]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[0]].b} ${classroomParams[currTrial.classroomPairing[0]].b === 1 ? 'tail' : 'tails'}.</b></li>
                            <li>The students in Classroom ${currTrial.classroomPairing[1]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[1]].a} \
                            ${classroomParams[currTrial.classroomPairing[1]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[1]].b} ${classroomParams[currTrial.classroomPairing[1]].b === 1 ? 'tail' : 'tails'}.</b></li>
                        </ul>
                        <h3>Select a set of examples to send to your student.</h3>
                        <p>Remember you can only select a max of ${params.maxFlips} examples.</p>
                        `
                }`
            ,
            html: `
                <p> <input name="heads" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> heads </p>
                <p> <input name="tails" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> tails </p>`,
            trial_duration: 30000,
            data: {
                type: 'response',
                condition: currTrial.condition,
                trueTheta: currTrial.coinWeight,
                classrooms: currTrial.classroomPairing,
                studentTrueClassroom: studentTrueClassroom,
                exampleSet: 'first'
            },
            on_finish: function (data) {
                var nHeads = parseInt(data.response.heads);
                var nTails = parseInt(data.response.tails);
                var studentTrueHypers = classroomParams[data.studentTrueClassroom];
                var studentGuess = (parseInt(studentTrueHypers.a) + nHeads) / (parseInt(studentTrueHypers.a) + parseInt(studentTrueHypers.b) + nHeads + nTails);
                var delta = Math.abs(data.trueTheta - studentGuess);
                var reward = delta <= params.perTrialBonusThreshold ? params.perTrialBonus : 0
                var cost = params.exampleCost * (nHeads + nTails)

                data.heads = nHeads;
                data.tails = nTails;
                data.studentIndex = i;
                data.studentTrueHypers = studentTrueHypers;
                data.studentGuess = studentGuess;
                data.delta = delta;
                data.totalExamples = nHeads + nTails;

                if (data.condition === 'nonSeqFull' || data.condition === 'nonSeqPartial') {
                    data.bonus = Number((reward - cost) > 0 ? (reward - cost).toFixed(2) : 0)
                }

                data.bonusSoFar = Number(jsPsych.data.get().select('bonus').sum().toFixed(2))
            }
        };

        var firstExampleLoop = {
            timeline: [firstExample],
            loop_function: function (data) {

                var totalFlips = parseInt(data.values()[0].response.heads) + parseInt(data.values()[0].response.tails)
                if ((totalFlips <= params.maxFlips) && (totalFlips > 0)) {
                    return false;
                } else {
                    return true;
                }
            }
        }

        var sending = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: 'Sending examples to student... ',
            choices: "NO_KEYS",
            trial_duration: function () {
                return jsPsych.randomization.sampleWithoutReplacement([1250, 1500, 1750, 2000], 1)[0];
            }
        }

        var feedback = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {

                var dataSoFar = jsPsych.data.get()
                var firstResponse = dataSoFar.filter({ studentIndex: i, exampleSet: 'first' }).values()[0]

                // console.log(firstResponse);

                return `
                <p>Student's guess for coin weight: <b style="color:Tomato;">${firstResponse.studentGuess.toFixed(2)}</b></p>
                <p>${firstResponse.condition != 'seqFeedback' ? `You received a bonus of <b>$${firstResponse.bonus}</b>. Total bonus so far: <b>$${Number(jsPsych.data.get().select('bonus').sum()).toFixed(2)}</b>` : ''}</b></p>
                <p>${firstResponse.condition === 'seqFeedback' ? `You will now send another set of examples to your student. <b>Remember to take your student's guess into consideration so that you can earn the highest bonus possible!</b> ` : ''}</p>
                <p>Press any key to continue.</p>
                `
            },
            trial_duration: 30000
        }
        // add function that samples from student class, saves info, and calculates hypers based on teacher's data

        var secondExample = {
            type: jsPsychSurveyHtmlForm,
            preamble: `<h2>Select another set of examples to send to the same student.</h2>
                        <p style="color:DodgerBlue; text-align: center;">Reminders:</p>
                        <ul style="color:DodgerBlue;">
                            <li>The weight of your coin is ${currTrial.coinWeight}.</li>
                            <li>Student ${i + 1} is from <b>either</b> Classroom ${currTrial.classroomPairing[0]} or Classroom ${currTrial.classroomPairing[1]}.</li>
                            <li>The students in Classroom ${currTrial.classroomPairing[0]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[0]].a} \
                            ${classroomParams[currTrial.classroomPairing[0]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[0]].b} ${classroomParams[currTrial.classroomPairing[0]].b === 1 ? 'tail' : 'tails'}.</b></li>
                            <li>The students in Classroom ${currTrial.classroomPairing[1]} have already seen \
                            <b>${classroomParams[currTrial.classroomPairing[1]].a} \
                            ${classroomParams[currTrial.classroomPairing[1]].a === 1 ? 'head' : 'heads'} and ${classroomParams[currTrial.classroomPairing[1]].b} ${classroomParams[currTrial.classroomPairing[1]].b === 1 ? 'tail' : 'tails'}.</b></li>
                        </ul>
            <p>Remember you can only select a max of ${params.maxFlips} examples.</p>
            `,
            html: `
                <p> <input name="heads" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> heads </p>
                <p> <input name="tails" type="number" required="true" min="0" max="${params.maxFlips}" value="0"/> tails </p>`,
            trial_duration: 30000,
            data: {
                type: 'response',
                condition: currTrial.condition,
                trueTheta: currTrial.coinWeight,
                classrooms: currTrial.classroomPairing,
                studentTrueClassroom: studentTrueClassroom,
                exampleSet: 'second'
            },
            on_finish: function (data) {

                var dataSoFar = jsPsych.data.get()
                var firstResponse = dataSoFar.filter({ studentIndex: i, exampleSet: 'first' }).values()[0]
                // console.log(firstResponse);

                var firstResponseHeads = firstResponse.heads;
                var firstResponseTails = firstResponse.tails;

                var nHeads = parseInt(data.response.heads);
                var nTails = parseInt(data.response.tails);
                var totalHeads = firstResponseHeads + nHeads;
                var totalTails = firstResponseTails + nTails;
                var studentTrueHypers = classroomParams[data.studentTrueClassroom];
                var studentGuess = (parseInt(studentTrueHypers.a) + totalHeads) / (parseInt(studentTrueHypers.a) + parseInt(studentTrueHypers.b) + totalHeads + totalTails);
                var delta = Math.abs(data.trueTheta - studentGuess);
                var reward = delta <= params.perTrialBonusThreshold ? params.perTrialBonus : 0
                var cost = params.exampleCost * (totalHeads + totalTails)

                data.firstResponseHeads = firstResponseHeads;
                data.firstResponseTails = firstResponseTails;
                data.secondResponseHeads = nHeads;
                data.secondResponseTails = nTails;
                data.totalHeads = totalHeads;
                data.totalTails = totalTails;
                data.studentIndex = i;
                data.studentTrueHypers = studentTrueHypers;
                data.studentGuess = studentGuess;
                data.delta = delta;
                data.bonus = Number((reward - cost) > 0 ? (reward - cost).toFixed(2) : 0);
                data.bonusSoFar = Number(dataSoFar.select('bonus').sum().toFixed(2))
                data.totalExamples = totalHeads + totalTails;
            }
        };

        var secondExampleLoop = {
            timeline: [secondExample],
            loop_function: function (data) {

                var totalFlips = parseInt(data.values()[0].response.heads) + parseInt(data.values()[0].response.tails)
                if ((totalFlips <= params.maxFlips) && (totalFlips > 0)) {
                    return false;
                } else {
                    return true;
                }
            }
        }

        var sent = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: 'Examples sent to student! Waiting for student...',
            choices: "NO_KEYS",
            trial_duration: function () {
                return jsPsych.randomization.sampleWithoutReplacement([4000, 4500, 5000, 5500, 6000], 1)[0];
            }
        }

        var finalSequentialFeedback = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {

                var dataSoFar = jsPsych.data.get()

                var firstResponse = dataSoFar.filter({ studentIndex: i, exampleSet: 'first' }).values()[0]
                var secondResponse = dataSoFar.filter({ studentIndex: i, exampleSet: 'second' }).values()[0]

                // console.log(firstResponse)
                // console.log(secondResponse)

                return `
                <p>Student ${i + 1}'s first guess for coin weight: <b style="color:Tomato";>${firstResponse.studentGuess.toFixed(2)}</b></p>
                <p>Student ${i + 1}'s second guess for coin weight: <b style="color:Tomato";>${secondResponse.studentGuess.toFixed(2)}</b></p>
                <p>You received a bonus of <b>$${secondResponse.bonus.toFixed(2)}</b> based on the student's second guess.</p>
                <p>Total bonus so far: <b>$${Number(jsPsych.data.get().select('bonus').sum()).toFixed(2)}</b></p>
                <p>Press any key to continue.</p>
                `
            },
            trial_duration: 30000
        }

        var fixation = {
            timeline: [
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: '<div style="font-size:60px;">Next student</div>',
                    choices: "NO_KEYS",
                    trial_duration: function () {
                        return jsPsych.randomization.sampleWithoutReplacement([2000, 2250, 2500, 3000], 1)[0];
                    }
                }
            ],

            // Skip if we are on last trial
            conditional_function: function () {
                if (i === design.length - 1) {
                    return false;
                } else {
                    return true;
                }
            }
        }

        const trialsInCondition = {
            'nonSeqFull': [classroomInfo, firstExampleLoop, sending, sent, feedback, fixation],
            'nonSeqPartial': [classroomInfo, firstExampleLoop, sending, sent, feedback, fixation],
            'seqNoFeedback': [classroomInfo, firstExampleLoop, sending, sent, secondExampleLoop, sending, sent, finalSequentialFeedback, fixation],
            'seqFeedback': [classroomInfo, firstExampleLoop, sending, sent, feedback, secondExampleLoop, sending, sent, finalSequentialFeedback, fixation],
        }

        timeline.push(trialsInCondition[currTrial.condition])
    }



    var survey = {
        type: jsPsychSurveyHtmlForm,
        preamble: `
        <p>You have reached the end of the experiment! To collect your bonus, please complete the following questions. </p>
        `,
        html:
        '<p><div style="margin-left:0%;text-align: left">Which gender do you most identify with?</div>'+
      	  '<div style="margin-left:0%;text-align: left"><input type="radio" id="genderChoice1" name="gender" value="male"><label for="genderChoice1">Male</label></div>'+
      	  '<div style="margin-left:0%;text-align: left"><input type="radio" id="genderChoice2" name="gender" value="female"><label for="genderChoice2">Female</label></div>' +
      	  '<div style="margin-left:0%;text-align: left"><input type="radio" id="genderChoice3" name="gender" value="nonconforming"><label for="genderChoice3">Gender Variant/Non-Conforming</label></div>' +
      	  '<div style="margin-left:0%;text-align: left"><input type="radio" id="genderChoice4" name="gender" value="abstain" required><label for="genderChoice4">Prefer not to answer</label></div></p>' +
      	  '<p><div style="margin-left:0%;text-align: left"><label for="age">Enter your age:</label></div>'+
      	  '<div style="margin-left:0%;text-align: left"><input type="text" id="age" name="age" required></div></p>' +
      	  '<p><div style="margin-left:0%;text-align: left"> Did you understand the instructions?</div>'+
      	  '<div style="margin-left:0%;text-align: left"><input type="radio" id="understoodChoice1" name="understood" value="yes" required><label for="understoodChoice1">Yes</label></div>'+
      	  '<div style="margin-left:0%;text-align: left"><input type="radio" id="understoodChoice2" name="understood" value="no"><label for="understoodChoice2">No</label></div></p>' +
      	  '<p><div style="margin-left:0%;text-align: left"><label for="comments">Comments or suggestions?</label></div>'+
      	  '<div style="margin-left:0%;text-align: left"><input type="text" id="comments" name="comments"></div></p>'
        ,
        button_label: ['Continue, save data, and collect bonus!'],
        data: {type: 'response'},
        on_finish:
            function (data) {
                var totalBonus = jsPsych.data.get().select('bonus').sum().toFixed(2);
                data.totalBonus = Number(totalBonus);
            },
    }

    timeline.push(survey);

    if (!local_testing) {
        timeline.push(save_data);
    }

    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {

            var totalBonus = jsPsych.data.get().select('bonus').sum().toFixed(2);
            var totalPay = Number(totalBonus) + Number(params.basePay);
            return `
                <p>Thanks for participating in the experiment!</p>
                <p>Your total bonus is <b>$${totalBonus}</b>.</p>
                <p>Your total pay is <b>$${totalPay}</b></p>
                <p>If you were curious, you weren't interacting with a real learner.</p>
                <p>Press any key to exit and collect your bonus.</p>
                `;

        }
    };

    timeline.push(debrief_block);

    jsPsych.run(timeline.flat());

</script>

</html>